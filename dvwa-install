#!/bin/bash

if [ "$EUID" -ne 0 ]
  then echo "Please run as root"
  exit
fi

echo ""
echo "This may take a while! Please run: "
echo "sudo apt-get update; sudo apt-get upgrade"
echo "before executing this script to speed up installation"
echo ""
echo "This script will automatically install: apache2, php5.6 and modules," 
echo "and install and configure Damn Vulnerable Web Application."
echo "you will need a google account to get Captcha keys and"
echo "enable the Captcha vulnerability module."
echo ""
while true; do
    read -p "Do you wish to continue (y/n) " yn
    case $yn in
        [Yy]* ) break;;
        [Nn]* ) exit;;
        * ) echo "Please answer yes or no.";;
    esac
done


# remove php7.0
sudo apt-get -y purge `dpkg -l | grep php | awk '{print $2}' |tr "\n" " "`

# install necessary packages and modules
sudo add-apt-repository -y ppa:ondrej/php
sudo apt-get update
sudo apt-get -y upgrade
sudo apt-get -y install php5.6 php5.6-mbstring php5.6-mcrypt php5.6-mysql php5.6-xml php5.6-gd
sudo apt-get -y install apache2
sudo apt-get -y install unzip

# in case you checked nginx in guided install
sudo apt-get -y purge nginx* 

sudo service apache2 start
sudo a2dismod php7.0
sudo a2enmod php5.6

# download dvwa to /var/www/html and unzip
sudo wget https://github.com/ethicalhack3r/DVWA/archive/v1.9.zip -P /var/www/html
sudo unzip /var/www/html/v1.9.zip -d /var/www/html/
sudo mv /var/www/html/DVWA-1.9 /var/www/html/dvwa

# edit /etc/php/5.6/apache2/php.ini to allow url_encode
sudo awk -i inplace '{ gsub("allow_url_include = Off", "allow_url_include = On") }1' /etc/php/5.6/apache2/php.ini 
# prompt for change password to mysql database 
echo ""
read -p "Enter desired password for the database: (leave blank for default: 'p@ssw0rd')" pass
case $pass in
        "" ) break; echo "Default username:password combo is root:p@ssw0rd" ;;
        * ) sudo awk -i inplace -v pass=$pass '{ gsub("p@ssw0rd", pass) }1' /var/www/html/dvwa/config/config.inc.php ;
            echo "Your username:password combo is root:$pass" ;; 
esac


# prompt for directions to generate reCAPTCHA key and enter into

# change permissions for all modules to work
sudo chgrp www-data /var/www/html/dvwa/hackable/uploads
sudo chgrp www-data /var/www/html/dvwa/external/phpids/0.6/lib/IDS/tmp/phpids_log.txt
sudo chmod 766 /var/www/html/dvwa/hackable/uploads/
sudo chmod 766 /var/www/html/dvwa/external/phpids/0.6/lib/IDS/tmp/phpids_log.txt
sudo update-rc.d apache2 defaults
sudo service apache2 restart

echo ""
echo "DVWA installation complete. "
echo "you can edit your captcha key and database settings (username/password) in: /var/www/html/dvwa/config/config.inc.php"
echo "Just type your IP address in your browser and follow link to begin!"
echo ""
